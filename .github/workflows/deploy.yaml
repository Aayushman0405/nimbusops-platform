name: Deploy NimbusOps Platform

on:
  push:
    branches: [ main, master ]
    paths:
      - 'k8s/**'
      - 'control-plane/**'
      - '.github/workflows/deploy.yaml'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # Manual trigger
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production
      component:
        description: 'Component to deploy'
        required: false
        type: string

env:
  REGISTRY: docker.io
  IMAGE_NAME: aayud/nimbusops-controller
  KUBE_NAMESPACE: aurora-system

jobs:
  build-and-test:
    runs-on: self-hosted  # Using your GitHub runner
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          
      - name: Test controller code
        run: |
          cd control-plane/scaler
          echo "Testing controller code..."
          python -c "import sys; sys.path.append('.'); from decision import decide_replicas; print('âœ… Decision module imports successfully')"
          python -c "import sys; sys.path.append('.'); from main import NimbusOpsController; print('âœ… Main module imports successfully')"
          
      - name: Build Docker image
        run: |
          cd control-plane/scaler
          docker build -t $REGISTRY/$IMAGE_NAME:${{ github.sha }} .
          echo "âœ… Docker image built"
          
      - name: Push to Docker Hub
        run: |
          cd control-plane/scaler
          docker login -u ${{ secrets.DOCKER_USERNAME }} -p ${{ secrets.DOCKER_PASSWORD }}
          docker push $REGISTRY/$IMAGE_NAME:${{ github.sha }}
          docker tag $REGISTRY/$IMAGE_NAME:${{ github.sha }} $REGISTRY/$IMAGE_NAME:latest
          docker push $REGISTRY/$IMAGE_NAME:latest
          echo "âœ… Docker image pushed"

  deploy:
    needs: build-and-test
    runs-on: self-hosted  # Using your GitHub runner
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up kubectl
        run: |
          # kubectl should already be installed on self-hosted runner
          kubectl version --client
          
      - name: Deploy NimbusOps Controller
        run: |
          echo "ðŸš€ Deploying NimbusOps Controller..."
          
          # Update image in deployment
          export NEW_IMAGE="$REGISTRY/$IMAGE_NAME:${{ github.sha }}"
          
          # Create temp deployment file with updated image
          cat > /tmp/nimbusops-deployment.yaml << DEPLOYMENT
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: nimbusops-controller
            namespace: $KUBE_NAMESPACE
            labels:
              app: nimbusops-controller
              version: github-${{ github.sha }}
          spec:
            replicas: 1
            selector:
              matchLabels:
                app: nimbusops-controller
            template:
              metadata:
                labels:
                  app: nimbusops-controller
                annotations:
                  prometheus.io/scrape: "true"
                  prometheus.io/port: "8001"
                  prometheus.io/path: "/metrics"
              spec:
                serviceAccountName: aurora-sa
                containers:
                  - name: controller
                    image: $NEW_IMAGE
                    imagePullPolicy: Always
                    ports:
                      - containerPort: 8001
                        name: metrics
                    env:
                      - name: PROMETHEUS_URL
                        value: http://prometheus.monitoring.svc.cluster.local:9090
          DEPLOYMENT
          
          # Apply deployment
          kubectl apply -f /tmp/nimbusops-deployment.yaml
          
      - name: Deploy RBAC
        run: |
          echo "ðŸ” Deploying RBAC..."
          kubectl apply -f k8s/base/rbac/nimbusops-rbac.yaml
          
      - name: Deploy Metrics Service
        run: |
          echo "ðŸ“Š Deploying Metrics Service..."
          
          # Create service for metrics
          cat > /tmp/nimbusops-service.yaml << SERVICE
          apiVersion: v1
          kind: Service
          metadata:
            name: nimbusops-controller-metrics
            namespace: $KUBE_NAMESPACE
          spec:
            selector:
              app: nimbusops-controller
            ports:
              - port: 8001
                targetPort: 8001
                name: metrics
          SERVICE
          
          kubectl apply -f /tmp/nimbusops-service.yaml
          
      - name: Deploy Grafana Dashboard
        run: |
          echo "ðŸ“ˆ Deploying Grafana Dashboard..."
          kubectl apply -f k8s/observability/nimbusops-dashboard/grafana-dashboard-nimbusops.yaml
          
      - name: Wait for rollout
        run: |
          echo "â³ Waiting for deployment to be ready..."
          kubectl rollout status deployment/nimbusops-controller -n $KUBE_NAMESPACE --timeout=300s
          
      - name: Verify deployment
        run: |
          echo "âœ… Verification..."
          kubectl get pods -n $KUBE_NAMESPACE -l app=nimbusops-controller
          kubectl get svc -n $KUBE_NAMESPACE -l app=nimbusops-controller
          
      - name: Get deployment logs
        run: |
          echo "ðŸ“‹ Getting logs..."
          kubectl logs -n $KUBE_NAMESPACE deployment/nimbusops-controller --tail=20

  notify:
    needs: deploy
    runs-on: self-hosted
    if: always()
    
    steps:
      - name: Send success notification
        if: success()
        run: |
          echo "âœ… NimbusOps deployment successful!"
          echo "Commit: ${{ github.sha }}"
          echo "Deployed by: ${{ github.actor }}"
          echo "Dashboard available at: http://grafana.monitoring.svc.cluster.local:3000"
          
      - name: Send failure notification
        if: failure()
        run: |
          echo "âŒ NimbusOps deployment failed!"
          echo "Commit: ${{ github.sha }}"
          echo "Failed step: ${{ job.status }}"
          exit 1
