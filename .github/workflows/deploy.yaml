name: Deploy NimbusOps Platform

on:
  push:
    branches: [ main, master ]
    paths:
      - 'k8s/**'
      - 'control-plane/**'
      - '.github/workflows/deploy.yaml'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

env:
  REGISTRY: docker.io
  IMAGE_NAME: aayud/nimbusops-controller
  KUBE_NAMESPACE: aurora-system

jobs:
  build-and-test:
    runs-on: self-hosted

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        run: |
          cd control-plane/scaler
          pip install -r requirements.txt
          echo "âœ… Dependencies installed"

      - name: Test controller logic (CI-safe)
        run: |
          cd control-plane/scaler
          echo "ðŸ§ª Testing controller logic..."

          python - << 'EOF'
          import sys
          sys.path.append(".")

          from decision import decide_replicas, decide_replicas_enhanced

          print("âœ… decision.py imports successfully")

          r = decide_replicas(3, 0.5)
          print(f"Decision test: 3 replicas @ 0.5 CPU â†’ {r}")

          enhanced = decide_replicas_enhanced(3, 0.5)
          replicas = enhanced["replicas"]
          cost_diff = enhanced["cost_impact"]["cost_difference_usd_per_hour"]

          print(f"Enhanced replicas: {replicas}")
          print(f"Cost diff: ${cost_diff}/hr")
          EOF

          python - << 'EOF'
          import sys
          sys.path.append(".")

          try:
              from prometheus_query import get_avg_cpu
              print("âœ… prometheus_query.py imports successfully")
          except Exception:
              print("âš ï¸ Prometheus not available in CI (expected)")
          EOF

          echo "ðŸ“¦ Files present:"
          ls -la *.py

      - name: Build Docker image
        run: |
          docker build \
            -t $REGISTRY/$IMAGE_NAME:${{ github.sha }} \
            -f control-plane/scaler/Dockerfile \
            control-plane/scaler/

          docker tag $REGISTRY/$IMAGE_NAME:${{ github.sha }} $REGISTRY/$IMAGE_NAME:latest
          echo "âœ… Docker image built"

      - name: Push Docker image
        run: |
          echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login \
            -u "${{ secrets.DOCKERHUB_USERNAME }}" \
            --password-stdin

          docker push $REGISTRY/$IMAGE_NAME:${{ github.sha }}
          docker push $REGISTRY/$IMAGE_NAME:latest
          echo "âœ… Docker image pushed"

  deploy:
    needs: build-and-test
    runs-on: self-hosted
    if: github.event_name != 'pull_request'

    steps:
      - uses: actions/checkout@v4

      - name: Verify kubectl
        run: kubectl version --client

      - name: Deploy NimbusOps Controller
        run: |
          echo "ðŸš€ Deploying NimbusOps Controller..."

          IMAGE="$REGISTRY/$IMAGE_NAME:${{ github.sha }}"

          sed "s|IMAGE_PLACEHOLDER|$IMAGE|g" \
            k8s/workloads/nimbusops-controller/deployment.yaml \
            | kubectl apply -f -

      - name: Deploy RBAC
        run: |
          kubectl apply -f k8s/base/rbac/nimbusops-rbac.yaml

      - name: Wait for rollout
        run: |
          kubectl rollout status deployment/nimbusops-controller \
            -n $KUBE_NAMESPACE --timeout=300s

      - name: Verify deployment
        run: |
          kubectl get pods -n $KUBE_NAMESPACE -l app=nimbusops-controller
          kubectl logs -n $KUBE_NAMESPACE deploy/nimbusops-controller --tail=20

  notify:
    needs: deploy
    runs-on: self-hosted
    if: always()

    steps:
      - name: Status
        run: |
          echo "Status: ${{ job.status }}"
          echo "Commit: ${{ github.sha }}"
          echo "Actor:  ${{ github.actor }}"
